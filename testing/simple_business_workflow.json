// Extract company data from webhook body - CORRECTED VERSION
const companyName = $json.body.company_name || 'Unknown Company';
const documents = $json.body.documents || [];

// Helper function to filter documents by type
function getDocumentsByType(type) {
  return documents.filter(d => d && d.type === type);
}

// Create Business OS Structure (0-9 Framework)
const businessOS = {
  "0": {
    "name": "Foundation",
    "description": "Core identity and governance",
    "subdomains": {
      "0.1": "Vision Mission Values",
      "0.2": "Legal Entity",
      "0.3": "Governance Structure"
    },
    "content": getDocumentsByType('mission_vision_values')
  },
  "1": {
    "name": "Market Intelligence", 
    "description": "Customer and market understanding",
    "subdomains": {
      "1.1": "Customer Personas",
      "1.2": "Market Research",
      "1.3": "Competitive Analysis"
    },
    "content": []
  },
  "2": {
    "name": "Brand & Marketing",
    "description": "Brand identity and marketing strategy",
    "subdomains": {
      "2.1": "Brand Guidelines",
      "2.2": "Marketing Strategy",
      "2.3": "Content Framework"
    },
    "content": getDocumentsByType('brand_guidelines')
  },
  "3": {
    "name": "Product & Innovation",
    "description": "Product development and innovation",
    "subdomains": {
      "3.1": "Product Roadmap",
      "3.2": "Feature Requirements",
      "3.3": "Innovation Pipeline"
    },
    "content": []
  },
  "4": {
    "name": "Operations",
    "description": "Day-to-day business operations", 
    "subdomains": {
      "4.1": "Process Documentation",
      "4.2": "Quality Management",
      "4.3": "Supply Chain"
    },
    "content": []
  },
  "5": {
    "name": "Technology & Systems",
    "description": "Technology infrastructure and systems",
    "subdomains": {
      "5.1": "Tech Stack",
      "5.2": "System Architecture",
      "5.3": "Development Process"
    },
    "content": getDocumentsByType('resource_inventory')
  },
  "6": {
    "name": "Human Resources",
    "description": "People, culture, and talent management",
    "subdomains": {
      "6.1": "Team Structure",
      "6.2": "Culture & Values",
      "6.3": "Talent Strategy"
    },
    "content": []
  },
  "7": {
    "name": "Finance & Legal",
    "description": "Financial management and legal compliance",
    "subdomains": {
      "7.1": "Financial Planning",
      "7.2": "Legal Compliance",
      "7.3": "Risk Management"
    },
    "content": []
  },
  "8": {
    "name": "Partnerships & Stakeholders",
    "description": "External relationships and partnerships",
    "subdomains": {
      "8.1": "Strategic Partnerships",
      "8.2": "Investor Relations",
      "8.3": "Community Engagement"
    },
    "content": []
  },
  "9": {
    "name": "Growth & Future",
    "description": "Future planning and growth strategies",
    "subdomains": {
      "9.1": "Growth Strategy",
      "9.2": "Future Roadmap",
      "9.3": "Scaling Plans"
    },
    "content": []
  }
};

// Generate implementation roadmap
const roadmap = {
  "phase_1": {
    "name": "Foundation Setup",
    "duration": "2-4 weeks",
    "domains": ["0", "2", "5"],
    "tasks": [
      "Document mission, vision, values",
      "Establish brand guidelines",
      "Map current technology stack"
    ]
  },
  "phase_2": {
    "name": "Market & Operations", 
    "duration": "4-6 weeks",
    "domains": ["1", "4", "6"],
    "tasks": [
      "Conduct market research",
      "Document core processes",
      "Define team structure"
    ]
  },
  "phase_3": {
    "name": "Growth & Optimization",
    "duration": "6-8 weeks", 
    "domains": ["3", "7", "8", "9"],
    "tasks": [
      "Develop product roadmap",
      "Establish financial planning",
      "Build partnership strategy"
    ]
  }
};

return [{
  company_name: companyName,
  business_os: businessOS,
  implementation_roadmap: roadmap,
  status: 'success',
  message: `Business OS structure generated for ${companyName}`,
  timestamp: new Date().toISOString(),
  debug: {
    documents_received: documents.length,
    documents_types: documents.map(d => d.type),
    foundation_content: getDocumentsByType('mission_vision_values').length,
    brand_content: getDocumentsByType('brand_guidelines').length,
    tech_content: getDocumentsByType('resource_inventory').length
  }
}];
